

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>data.data &mdash; ThemisPy 0.3.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="ThemisPy 0.3.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../docs/src/index.html" class="icon icon-home"> ThemisPy
          

          
          </a>

          
            
            
              <div class="version">
                0.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../docs/src/installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/src/userguide.html">User’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/src/devel.html">Developer’s Guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../docs/src/index.html">ThemisPy</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          













<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    
      <li><a href="../../docs/src/index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>data.data</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for data.data</h1><div class="highlight"><pre>
<span></span><span class="c1">###########################</span>
<span class="c1">#</span>
<span class="c1"># Package:</span>
<span class="c1">#   data</span>
<span class="c1">#</span>
<span class="c1"># Provides:</span>
<span class="c1">#   Functions for preprocessing uvfits files to produce Themis-formatted data files</span>
<span class="c1">#   and to generate uvfits files from Themis results.</span>
<span class="c1">#</span>

<span class="kn">from</span> <span class="nn">themispy.utils</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Read in astropy, if possible</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
    <span class="n">astropy_found</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Package astropy not found.  Some functionality will not be available.  If this is necessary, please ensure astropy is installed.&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
    <span class="n">astropy_found</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># # Read in ehtim, if possible</span>
<span class="c1"># try:</span>
<span class="c1">#     import ehtim as eh</span>
<span class="c1">#     ehtim_found = True</span>
<span class="c1"># except:</span>
<span class="c1">#     warnings.warn(&quot;Package ehtim not found.  Some functionality will not be available.  If this is necessary, please ensure ehtim is installed.&quot;, Warning)</span>
<span class="c1">#     ehtim_found = False</span>


<div class="viewcode-block" id="closure_phase_covariance_ordering"><a class="viewcode-back" href="../../docs/src/data.html#data.data.closure_phase_covariance_ordering">[docs]</a><span class="k">def</span> <span class="nf">closure_phase_covariance_ordering</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates and returns a set of closure phases with the smallest off-diagonal </span>
<span class="sd">    covariances possible.  For EHT data this is possible due to the presence of</span>
<span class="sd">    a uniquely sensitive anchor station, ALMA, and may not be generally possible</span>
<span class="sd">    for other data sets.</span>

<span class="sd">    Warning: </span>
<span class="sd">      This makes extensive use of ehtim and will not be available if ehtim is not installed.  Raises a NotImplementedError if ehtim is unavailable.</span>

<span class="sd">    Args:</span>
<span class="sd">      obs (ehtim.obsdata.Obsdata): An ehtim Obsdata object containing the observation data (presumably repackaging a uvfits file).</span>
<span class="sd">      snrcut (float): A possible signal-to-noise ratio below which to reject points. Default: 0.</span>
<span class="sd">      verbosity (int): Verbosity level. 0 prints only warnings and errors.  1 prints information about each observation period.</span>

<span class="sd">    Returns:</span>
<span class="sd">      (numpy.recarray): An ehtim closure phase array.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ehtim_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    
    <span class="c1"># make a copy</span>
    <span class="n">obs2</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># compute a maximum set of closure phases</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">reorder_tarr_snr</span><span class="p">()</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">add_cphase</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    
    <span class="c1"># compute a &quot;minimum&quot; set of closure phases</span>
    <span class="n">obs2</span><span class="o">.</span><span class="n">reorder_tarr_snr</span><span class="p">()</span>
    <span class="n">obs2</span><span class="o">.</span><span class="n">add_cphase</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    
    <span class="c1"># organize some info</span>
    <span class="n">time_vis</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="n">time_cp</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">cphase</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
    <span class="n">t1_vis</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span>
    <span class="n">t2_vis</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span>
    
    <span class="c1"># Determine the number of timestamps containing a closure triangle</span>
    <span class="n">timestamps_cp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">time_cp</span><span class="p">)</span>
    <span class="n">N_times_cp</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timestamps_cp</span><span class="p">)</span>
    
    <span class="c1"># loop over all timestamps</span>
    <span class="n">obs_cphase_arr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N_times_cp</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
    
        <span class="c1"># get the current timestamp</span>
        <span class="n">ind_here_cp</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_cp</span> <span class="o">==</span> <span class="n">timestamps_cp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">time_here</span> <span class="o">=</span> <span class="n">time_cp</span><span class="p">[</span><span class="n">ind_here_cp</span><span class="p">]</span>
    
        <span class="c1"># copy the cphase table for this timestamp</span>
        <span class="n">obs_cphase_orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">cphase</span><span class="p">[</span><span class="n">ind_here_cp</span><span class="p">])</span>
    
        <span class="c1"># sort by cphase SNR</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span><span class="p">)</span><span class="o">*</span><span class="n">obs_cphase_orig</span><span class="p">[</span><span class="s1">&#39;sigmacp&#39;</span><span class="p">])</span>
        <span class="n">ind_snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
        <span class="n">obs_cphase_orig</span> <span class="o">=</span> <span class="n">obs_cphase_orig</span><span class="p">[</span><span class="n">ind_snr</span><span class="p">]</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="n">snr</span><span class="p">[</span><span class="n">ind_snr</span><span class="p">]</span>
    
        <span class="c1"># organize the closure phase stations</span>
        <span class="n">cp_ant1_vec</span> <span class="o">=</span> <span class="n">obs_cphase_orig</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span>
        <span class="n">cp_ant2_vec</span> <span class="o">=</span> <span class="n">obs_cphase_orig</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span>
        <span class="n">cp_ant3_vec</span> <span class="o">=</span> <span class="n">obs_cphase_orig</span><span class="p">[</span><span class="s1">&#39;t3&#39;</span><span class="p">]</span>
    
        <span class="c1"># get the number of time-matched baselines</span>
        <span class="n">ind_here_bl</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_vis</span> <span class="o">==</span> <span class="n">timestamps_cp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">B_here</span> <span class="o">=</span> <span class="n">ind_here_bl</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
        <span class="c1"># organize the time-matched baseline stations</span>
        <span class="n">bl_ant1_vec</span> <span class="o">=</span> <span class="n">t1_vis</span><span class="p">[</span><span class="n">ind_here_bl</span><span class="p">]</span>
        <span class="n">bl_ant2_vec</span> <span class="o">=</span> <span class="n">t2_vis</span><span class="p">[</span><span class="n">ind_here_bl</span><span class="p">]</span>
    
        <span class="c1"># initialize the design matrix</span>
        <span class="n">design_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ind_here_cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">B_here</span><span class="p">))</span>
    
        <span class="c1"># fill in each row of the design matrix</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ind_here_cp</span><span class="o">.</span><span class="n">sum</span><span class="p">()):</span>
    
            <span class="c1"># determine which stations are in this triangle</span>
            <span class="n">ant1_here</span> <span class="o">=</span> <span class="n">cp_ant1_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">ant2_here</span> <span class="o">=</span> <span class="n">cp_ant2_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">ant3_here</span> <span class="o">=</span> <span class="n">cp_ant3_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            
            <span class="c1"># matrix entry for first leg of triangle</span>
            <span class="n">ind1_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant1_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant2_here</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ind1_here</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">ind1_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant2_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant1_here</span><span class="p">))</span>
                <span class="n">val1_here</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val1_here</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">design_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ind1_here</span><span class="p">]</span> <span class="o">=</span> <span class="n">val1_here</span>
            
            <span class="c1"># matrix entry for second leg of triangle</span>
            <span class="n">ind2_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant2_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant3_here</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ind2_here</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">ind2_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant3_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant2_here</span><span class="p">))</span>
                <span class="n">val2_here</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val2_here</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">design_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ind2_here</span><span class="p">]</span> <span class="o">=</span> <span class="n">val2_here</span>
            
            <span class="c1"># matrix entry for third leg of triangle</span>
            <span class="n">ind3_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant3_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant1_here</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ind3_here</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">ind3_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant1_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant3_here</span><span class="p">))</span>
                <span class="n">val3_here</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val3_here</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">design_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ind3_here</span><span class="p">]</span> <span class="o">=</span> <span class="n">val3_here</span>
    
        <span class="c1"># determine the expected size of the minimal set</span>
        <span class="n">N_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">design_mat</span><span class="p">)</span>
        <span class="n">N_assumed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs2</span><span class="o">.</span><span class="n">cphase</span><span class="p">[</span><span class="s1">&#39;cphase&#39;</span><span class="p">][</span><span class="n">obs2</span><span class="o">.</span><span class="n">cphase</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">timestamps_cp</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    
        <span class="c1"># print some info</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For timestamp &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">timestamps_cp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    
        <span class="c1"># get the current stations</span>
        <span class="n">stations_here</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">cp_ant1_vec</span><span class="p">,</span><span class="n">cp_ant2_vec</span><span class="p">,</span><span class="n">cp_ant3_vec</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Observing stations are &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">station</span><span class="p">)</span> <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">stations_here</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size of maximal set of closure phases = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind_here_cp</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size of minimal set of closure phases = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N_min</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size of minimal set of closure phases currently calculated by ehtim = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N_assumed</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;...&#39;</span><span class="p">)</span>
    
        <span class="c1">##########################################################</span>
        <span class="c1"># start of loop to recover minimal set</span>
        <span class="c1">##########################################################</span>
    
        <span class="c1"># make a mask to keep track of which cphases will stick around</span>
        <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_cphase_orig</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">obs_cphase</span> <span class="o">=</span> <span class="n">obs_cphase_orig</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
    
        <span class="c1"># remember the original minimal set size</span>
        <span class="n">N_min_orig</span> <span class="o">=</span> <span class="n">N_min</span>
    
        <span class="c1"># initialize the loop breaker</span>
        <span class="n">good_enough</span> <span class="o">=</span> <span class="kc">False</span>
    
        <span class="c1"># perform the loop</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ind_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">good_enough</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
    
            <span class="c1"># recreate the mask each time</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_cphase_orig</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">keep</span><span class="p">[</span><span class="n">ind_list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">obs_cphase</span> <span class="o">=</span> <span class="n">obs_cphase_orig</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
    
            <span class="c1"># organize the closure phase stations</span>
            <span class="n">cp_ant1_vec</span> <span class="o">=</span> <span class="n">obs_cphase</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span>
            <span class="n">cp_ant2_vec</span> <span class="o">=</span> <span class="n">obs_cphase</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span>
            <span class="n">cp_ant3_vec</span> <span class="o">=</span> <span class="n">obs_cphase</span><span class="p">[</span><span class="s1">&#39;t3&#39;</span><span class="p">]</span>
    
            <span class="c1"># get the number of time-matched baselines</span>
            <span class="n">ind_here_bl</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_vis</span> <span class="o">==</span> <span class="n">timestamps_cp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">B_here</span> <span class="o">=</span> <span class="n">ind_here_bl</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
            <span class="c1"># organize the time-matched baseline stations</span>
            <span class="n">bl_ant1_vec</span> <span class="o">=</span> <span class="n">t1_vis</span><span class="p">[</span><span class="n">ind_here_bl</span><span class="p">]</span>
            <span class="n">bl_ant2_vec</span> <span class="o">=</span> <span class="n">t2_vis</span><span class="p">[</span><span class="n">ind_here_bl</span><span class="p">]</span>
    
            <span class="c1"># initialize the design matrix</span>
            <span class="n">design_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">keep</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="n">B_here</span><span class="p">))</span>
    
            <span class="c1"># fill in each row of the design matrix</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">keep</span><span class="o">.</span><span class="n">sum</span><span class="p">()):</span>
    
                <span class="c1"># determine which stations are in this triangle</span>
                <span class="n">ant1_here</span> <span class="o">=</span> <span class="n">cp_ant1_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">ant2_here</span> <span class="o">=</span> <span class="n">cp_ant2_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">ant3_here</span> <span class="o">=</span> <span class="n">cp_ant3_vec</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                
                <span class="c1"># matrix entry for first leg of triangle</span>
                <span class="n">ind1_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant1_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant2_here</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ind1_here</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">ind1_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant2_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant1_here</span><span class="p">))</span>
                    <span class="n">val1_here</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val1_here</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">design_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ind1_here</span><span class="p">]</span> <span class="o">=</span> <span class="n">val1_here</span>
                
                <span class="c1"># matrix entry for second leg of triangle</span>
                <span class="n">ind2_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant2_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant3_here</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ind2_here</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">ind2_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant3_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant2_here</span><span class="p">))</span>
                    <span class="n">val2_here</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val2_here</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">design_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ind2_here</span><span class="p">]</span> <span class="o">=</span> <span class="n">val2_here</span>
                
                <span class="c1"># matrix entry for third leg of triangle</span>
                <span class="n">ind3_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant3_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant1_here</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ind3_here</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">ind3_here</span> <span class="o">=</span> <span class="p">((</span><span class="n">bl_ant1_vec</span> <span class="o">==</span> <span class="n">ant1_here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bl_ant2_vec</span> <span class="o">==</span> <span class="n">ant3_here</span><span class="p">))</span>
                    <span class="n">val3_here</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val3_here</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">design_mat</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="n">ind3_here</span><span class="p">]</span> <span class="o">=</span> <span class="n">val3_here</span>
    
            <span class="c1"># determine the size of the minimal set</span>
            <span class="n">N_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">design_mat</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="p">(</span><span class="n">keep</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="n">N_min_orig</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">N_min</span> <span class="o">==</span> <span class="n">N_min_orig</span><span class="p">):</span>
                <span class="n">good_enough</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">N_min</span> <span class="o">==</span> <span class="n">N_min_orig</span><span class="p">:</span>
                    <span class="n">ind_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ind_list</span> <span class="o">=</span> <span class="n">ind_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">count</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_cphase_orig</span><span class="p">):</span>
                <span class="k">break</span>
    
        <span class="c1"># print out the size of the recovered set for double-checking</span>
        <span class="n">obs_cphase</span> <span class="o">=</span> <span class="n">obs_cphase_orig</span><span class="p">[</span><span class="n">keep</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obs_cphase</span><span class="p">)</span> <span class="o">!=</span> <span class="n">N_min</span> <span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Minimal set of closure phases not found.&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*****************WARNING: minimal set not found*****************&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Size of recovered minimal set = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_cphase</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;========================================================================&#39;</span><span class="p">)</span>
    
        <span class="n">obs_cphase_arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs_cphase</span><span class="p">)</span>
    
    <span class="c1"># save an output cphase file</span>
    <span class="n">obs_cphase_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">obs_cphase_arr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obs_cphase_arr</span></div>


<div class="viewcode-block" id="reconstruct_field_rotation_angles"><a class="viewcode-back" href="../../docs/src/data.html#data.data.reconstruct_field_rotation_angles">[docs]</a><span class="k">def</span> <span class="nf">reconstruct_field_rotation_angles</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">isER5</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reconstructs the field rotation angle for polarization data from sub-quantities.  Also </span>
<span class="sd">    implements, upon request, corrections that are appropriate for ER5 data.  Should be</span>
<span class="sd">    deprecated for data generated following ER5 (e.g., upon the release of ER6 and for </span>
<span class="sd">    subsequent intervening releases).</span>

<span class="sd">    Warning: </span>
<span class="sd">      This makes extensive use of ehtim and will not be available if ehtim is not installed.  Raises a NotImplementedError if ehtim is unavailable.</span>

<span class="sd">    Args:</span>
<span class="sd">      obs (ehtim.obsdata.Obsdata): An ehtim Obsdata object containing the observation data (presumably repackaging a uvfits file).</span>
<span class="sd">      isER5 (bool): Flag to indicate that this is an ER5 file with polconvert errors that modify the field rotation angles. Default: False.</span>

<span class="sd">    Returns:</span>
<span class="sd">      (numpy.ndarray,numpy.ndarray): Field rotation angles for station1 and station2 for the full data set in obs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ehtim_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    
    
    <span class="c1"># An error in polconvert imparted phase errors in the ER5 R and L products that</span>
    <span class="c1"># propagated into RR,LL,RL,LL.  This must be fixed ONLY for ER5 data products.</span>
    <span class="c1"># WARNING: This should NOT be applied to any other data product!  For example,</span>
    <span class="c1"># simulated data or subsequent data releases (ER6).</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isER5</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Correcting the absolute EVPA calibration in ER5 data.  Should not be done for any other data (simulated, later releases, etc.).&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
        <span class="n">datadict</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">0.0</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">eh</span><span class="o">.</span><span class="n">DTCAL</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">}</span>
        <span class="n">caltab</span> <span class="o">=</span> <span class="n">eh</span><span class="o">.</span><span class="n">caltable</span><span class="o">.</span><span class="n">Caltable</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span><span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span><span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span><span class="n">datadict</span><span class="p">,</span><span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">caltab</span><span class="o">.</span><span class="n">applycal</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span><span class="n">extrapolate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">####</span>
    <span class="c1">## Construct field rotation correction vectors</span>

    <span class="c1"># Get vector of station names</span>
    <span class="n">ant1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">])</span>
    <span class="n">ant2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">])</span>
    
    <span class="c1"># Get vector of elevations</span>
    <span class="n">el1</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">unpack</span><span class="p">([</span><span class="s1">&#39;el1&#39;</span><span class="p">],</span><span class="n">ang_unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)[</span><span class="s1">&#39;el1&#39;</span><span class="p">]</span>
    <span class="n">el2</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">unpack</span><span class="p">([</span><span class="s1">&#39;el2&#39;</span><span class="p">],</span><span class="n">ang_unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)[</span><span class="s1">&#39;el2&#39;</span><span class="p">]</span>
    
    <span class="c1"># Get vector of parallactic angles</span>
    <span class="n">par1</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">unpack</span><span class="p">([</span><span class="s1">&#39;par_ang1&#39;</span><span class="p">],</span><span class="n">ang_unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)[</span><span class="s1">&#39;par_ang1&#39;</span><span class="p">]</span>
    <span class="n">par2</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">unpack</span><span class="p">([</span><span class="s1">&#39;par_ang2&#39;</span><span class="p">],</span><span class="n">ang_unit</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">)[</span><span class="s1">&#39;par_ang2&#39;</span><span class="p">]</span>

    <span class="c1"># Apparently simple linear relationship between the el,par,telescope-specific offset, and the </span>
    <span class="c1"># field rotation angle. All of these single constants that depend on mount type, etc., and are -1,0,1.</span>
    <span class="c1"># Station 1:</span>
    <span class="n">f_el1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">el1</span><span class="p">)</span>
    <span class="n">f_par1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">par1</span><span class="p">)</span>
    <span class="n">f_off1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">el1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">a1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ant1</span><span class="p">):</span>
        <span class="n">ind1</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">a1</span><span class="p">)</span>
        <span class="n">f_el1</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">[</span><span class="n">ind1</span><span class="p">][</span><span class="s1">&#39;fr_elev&#39;</span><span class="p">]</span>
        <span class="n">f_par1</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">[</span><span class="n">ind1</span><span class="p">][</span><span class="s1">&#39;fr_par&#39;</span><span class="p">]</span>
        <span class="n">f_off1</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">[</span><span class="n">ind1</span><span class="p">][</span><span class="s1">&#39;fr_off&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">eh</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="c1"># Station 2:</span>
    <span class="n">f_el2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">el2</span><span class="p">)</span>
    <span class="n">f_par2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">par2</span><span class="p">)</span>
    <span class="n">f_off2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">el2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ant2</span><span class="p">):</span>
        <span class="n">ind2</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">a2</span><span class="p">)</span>
        <span class="n">f_el2</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">[</span><span class="n">ind2</span><span class="p">][</span><span class="s1">&#39;fr_elev&#39;</span><span class="p">]</span>
        <span class="n">f_par2</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">[</span><span class="n">ind2</span><span class="p">][</span><span class="s1">&#39;fr_par&#39;</span><span class="p">]</span>
        <span class="n">f_off2</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">[</span><span class="n">ind2</span><span class="p">][</span><span class="s1">&#39;fr_off&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">eh</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="c1"># Compute the field rotation angles, phi, for each station</span>
    <span class="n">FR1</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_el1</span><span class="o">*</span><span class="n">el1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">f_par1</span><span class="o">*</span><span class="n">par1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f_off1</span>
    <span class="n">FR2</span> <span class="o">=</span> <span class="p">(</span><span class="n">f_el2</span><span class="o">*</span><span class="n">el2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">f_par2</span><span class="o">*</span><span class="n">par2</span><span class="p">)</span> <span class="o">+</span> <span class="n">f_off2</span>

    <span class="c1"># Convert to radians</span>
    <span class="c1">#FR1 = FR1*np.pi/180.</span>
    <span class="c1">#FR2 = FR2*np.pi/180.</span>

    <span class="n">obs</span><span class="o">.</span><span class="n">switch_polrep</span><span class="p">(</span><span class="s1">&#39;stokes&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">FR1</span><span class="p">,</span><span class="n">FR2</span></div>


<div class="viewcode-block" id="write_crosshand_visibilities"><a class="viewcode-back" href="../../docs/src/data.html#data.data.write_crosshand_visibilities">[docs]</a><span class="k">def</span> <span class="nf">write_crosshand_visibilities</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">isER5</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_partial_hands</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">flip_field_rotation_angles</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes complex crosshand RR,LL,RL,LR visibilities in Themis format given an :class:`ehtim.obsdata.Obsdata` object.</span>

<span class="sd">    Warning: </span>
<span class="sd">      * The :class:`ehtim.obsdata.Obsdata` must be read in with a polrep=&#39;circ&#39;.  If this is not the case, raises a ValueError.  DO NOT SWITCH THE POLREP AS THIS INFLATES THE ERRORS.</span>
<span class="sd">      * This makes extensive use of ehtim and astropy and will not be available if either is not installed.  Raises a NotImplementedError if they are is unavailable.</span>

<span class="sd">    Args:</span>
<span class="sd">      obs (ehtim.obsdata.Obsdata): An ehtim Obsdata object containing the observation data (presumably repackaging a uvfits file).</span>
<span class="sd">      outname (str): Name of the output file to which to write data.</span>
<span class="sd">      isER5 (bool): Flag to indicate that this is an ER5 file with polconvert errors that modify the field rotation angles. Default: False.</span>
<span class="sd">      snrcut (float): A possible signal-to-noise ratio below which to reject points. Default: 0.</span>
<span class="sd">      keep_partial_hands (bool): Flag to deterime how to treat data with incomplete polarization information.  If true, the single-hand visibilities are kept, and large errors are assigned to correlation products that include other hands. Default: True.</span>

<span class="sd">    Returns:</span>
<span class="sd">      None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ehtim_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">astropy_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># Check polrep</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">polrep</span><span class="o">!=</span><span class="s1">&#39;circ&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Must supply an obs object with polrep=&#39;circ&#39;&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>

    <span class="c1"># Get some dataset particulars</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">source</span>
    <span class="n">mjd</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">mjd</span>
    <span class="n">t</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">year</span><span class="p">,</span><span class="n">day</span><span class="p">]</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">yday</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
    
    <span class="c1"># Get the field rotation angles</span>
    <span class="n">fr1</span><span class="p">,</span><span class="n">fr2</span><span class="o">=</span><span class="n">reconstruct_field_rotation_angles</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">isER5</span><span class="o">=</span><span class="n">isER5</span><span class="p">)</span>

    <span class="c1"># Flip (debugging)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flip_field_rotation_angles</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">fr1</span> <span class="o">=</span> <span class="o">-</span><span class="n">fr1</span>
        <span class="n">fr2</span> <span class="o">=</span> <span class="o">-</span><span class="n">fr2</span>

    <span class="c1"># Write header</span>
    <span class="n">out</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%24s</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39; day&#39;</span><span class="p">,</span><span class="s1">&#39;time (hr)&#39;</span><span class="p">,</span><span class="s1">&#39;base&#39;</span><span class="p">,</span><span class="s1">&#39;u (Ml)&#39;</span><span class="p">,</span><span class="s1">&#39;v (Ml)&#39;</span><span class="p">,</span><span class="s1">&#39;fr1 (rad)&#39;</span><span class="p">,</span> <span class="s1">&#39;fr2 (rad)&#39;</span><span class="p">,</span><span class="s1">&#39;RR.r (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;RRerr.r (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;RR.i (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;RRerr.i (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;LL.r (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;LLerr.r (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;LL.i (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;LLerr.i (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;RL.r (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;RLerr.r (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;RL.i (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;RLerr.i (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;LR.r (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;LRerr.r (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;LR.i (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;LRerr.i (Jy)&#39;</span><span class="p">))</span>

    <span class="c1"># Loop over data and output</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="p">:</span>

        <span class="n">time</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">RR</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;rrvis&#39;</span><span class="p">]</span>
        <span class="n">RRerr</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;rrsigma&#39;</span><span class="p">]</span>
        <span class="n">LL</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;llvis&#39;</span><span class="p">]</span>
        <span class="n">LLerr</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;llsigma&#39;</span><span class="p">]</span>
        <span class="n">RL</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;rlvis&#39;</span><span class="p">]</span>
        <span class="n">RLerr</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;rlsigma&#39;</span><span class="p">]</span>
        <span class="n">LR</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;lrvis&#39;</span><span class="p">]</span>
        <span class="n">LRerr</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;lrsigma&#39;</span><span class="p">]</span>

        <span class="n">SNR</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">RR</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LL</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">RRerr</span><span class="o">+</span><span class="n">LLerr</span><span class="p">)</span>
        
        <span class="c1"># If we want to still use only partial-hand visibilities, </span>
        <span class="k">if</span> <span class="p">(</span><span class="n">keep_partial_hands</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RR</span><span class="p">))</span> <span class="p">:</span>
                <span class="n">RR</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">0.0</span>
                <span class="n">RRerr</span> <span class="o">=</span> <span class="mf">100.0</span>
                <span class="n">SNR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LL</span><span class="p">)</span><span class="o">/</span><span class="n">LLerr</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LL</span><span class="p">))</span> <span class="p">:</span>
                <span class="n">LL</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">0.0</span>
                <span class="n">LLerr</span> <span class="o">=</span> <span class="mf">100.0</span>
                <span class="n">SNR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">RR</span><span class="p">)</span><span class="o">/</span><span class="n">RRerr</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">RL</span><span class="p">))</span> <span class="p">:</span>
                <span class="n">RL</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">0.0</span>
                <span class="n">RLerr</span> <span class="o">=</span> <span class="mf">100.0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LR</span><span class="p">))</span> <span class="p">:</span>
                <span class="n">LR</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="mf">0.0</span>
                <span class="n">LRerr</span> <span class="o">=</span> <span class="mf">100.0</span>


        <span class="c1"># Only output data that does not include nans</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">([</span><span class="n">RR</span><span class="p">,</span><span class="n">LL</span><span class="p">,</span><span class="n">RL</span><span class="p">,</span><span class="n">LR</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">SNR</span><span class="o">&gt;</span><span class="n">snrcut</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%25s</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">bl</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">fr1</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">fr2</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">RR</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="n">RRerr</span><span class="p">,</span><span class="n">RR</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span><span class="n">RRerr</span><span class="p">,</span><span class="n">LL</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="n">LLerr</span><span class="p">,</span><span class="n">LL</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span><span class="n">LLerr</span><span class="p">,</span><span class="n">RL</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="n">RLerr</span><span class="p">,</span><span class="n">RL</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span><span class="n">RLerr</span><span class="p">,</span><span class="n">LR</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="n">LRerr</span><span class="p">,</span><span class="n">LR</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span><span class="n">LRerr</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;NaN crosshand visibilities found on </span><span class="si">%4s</span><span class="s2"> baseline, perhaps one hand is missing?&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">bl</span><span class="p">),</span> <span class="ne">Warning</span><span class="p">)</span>

    <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>




<div class="viewcode-block" id="write_visibilities"><a class="viewcode-back" href="../../docs/src/data.html#data.data.write_visibilities">[docs]</a><span class="k">def</span> <span class="nf">write_visibilities</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes complex visibilities (Stokes I) in Themis format given an :class:`ehtim.obsdata.Obsdata` object.</span>

<span class="sd">    Warning: </span>
<span class="sd">      * The :class:`ehtim.obsdata.Obsdata` must be read in with a polrep=&#39;stokes&#39;.  If this is not the case, raises a ValueError.  DO NOT SWITCH THE POLREP AS THIS INFLATES THE ERRORS.</span>
<span class="sd">      * This makes extensive use of ehtim and astropy and will not be available if either is not installed.  Raises a NotImplementedError if they are is unavailable.</span>

<span class="sd">    Args:</span>
<span class="sd">      obs (ehtim.obsdata.Obsdata): An ehtim Obsdata object containing the observation data (presumably repackaging a uvfits file).</span>
<span class="sd">      outname (str): Name of the output file to which to write data.</span>
<span class="sd">      snrcut (float): A possible signal-to-noise ratio below which to reject points. Default: 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">      None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ehtim_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">astropy_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># Check polrep</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">polrep</span><span class="o">!=</span><span class="s1">&#39;stokes&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Must supply an obs object with polrep=&#39;stokes&#39;&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    
    <span class="c1"># Get some dataset particulars</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">source</span>
    <span class="n">mjd</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">mjd</span>
    <span class="n">t</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">year</span><span class="p">,</span><span class="n">day</span><span class="p">]</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">yday</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
    
    <span class="c1"># Write header</span>
    <span class="n">out</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%24s</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39; day&#39;</span><span class="p">,</span><span class="s1">&#39;time (hr)&#39;</span><span class="p">,</span><span class="s1">&#39;base&#39;</span><span class="p">,</span><span class="s1">&#39;u (Ml)&#39;</span><span class="p">,</span><span class="s1">&#39;v (Ml)&#39;</span><span class="p">,</span><span class="s1">&#39;V.r (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;err.r (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;V.i (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;err.i (Jy)&#39;</span><span class="p">))</span>

    <span class="c1"># Write data file</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span> <span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span><span class="o">/</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="n">snrcut</span> <span class="p">)</span> <span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%25s</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">bl</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">cv</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="n">err</span><span class="p">,</span><span class="n">cv</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span><span class="n">err</span><span class="p">))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    

<div class="viewcode-block" id="write_amplitudes"><a class="viewcode-back" href="../../docs/src/data.html#data.data.write_amplitudes">[docs]</a><span class="k">def</span> <span class="nf">write_amplitudes</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">debias_amplitudes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes visibility amplitudes in Themis format given an :class:`ehtim.obsdata.Obsdata` object.</span>

<span class="sd">    Warning: </span>
<span class="sd">      * The :class:`ehtim.obsdata.Obsdata` must be read in with a polrep=&#39;stokes&#39;.  If this is not the case, raises a ValueError.  DO NOT SWITCH THE POLREP AS THIS INFLATES THE ERRORS.</span>
<span class="sd">      * This makes extensive use of ehtim and astropy and will not be available if either is not installed.  Raises a NotImplementedError if they are is unavailable.</span>

<span class="sd">    Args:</span>
<span class="sd">      obs (ehtim.obsdata.Obsdata): An ehtim Obsdata object containing the observation data (presumably repackaging a uvfits file).</span>
<span class="sd">      outname (str): Name of the output file to which to write data.</span>
<span class="sd">      debias_amplitudes (bool): Flag that sets amplitudes should be debiased in the normal way: :math:`V_{db}=\sqrt{V^2-\sigma^2}`. Default: True.</span>
<span class="sd">      snrcut (float): A possible signal-to-noise ratio below which to reject points. Default: 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">      None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ehtim_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">astropy_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># Check polrep</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">polrep</span><span class="o">!=</span><span class="s1">&#39;stokes&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Must supply an obs object with polrep=&#39;stokes&#39;&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>

    <span class="c1"># Get some dataset particulars</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">source</span>
    <span class="n">mjd</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">mjd</span>
    <span class="n">t</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">year</span><span class="p">,</span><span class="n">day</span><span class="p">]</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">yday</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Make sure amplitudes are defined</span>
    <span class="n">obs</span><span class="o">.</span><span class="n">add_amp</span><span class="p">(</span><span class="n">debias</span><span class="o">=</span><span class="n">debias_amplitudes</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>

    <span class="c1"># Write header</span>
    <span class="n">out</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%24s</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39; day&#39;</span><span class="p">,</span><span class="s1">&#39;time (hr)&#39;</span><span class="p">,</span><span class="s1">&#39;base&#39;</span><span class="p">,</span><span class="s1">&#39;u (Ml)&#39;</span><span class="p">,</span><span class="s1">&#39;v (Ml)&#39;</span><span class="p">,</span><span class="s1">&#39;VA (Jy)&#39;</span><span class="p">,</span><span class="s1">&#39;err (Jy)&#39;</span><span class="p">))</span>

    <span class="c1"># Write data file</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">amp</span> <span class="p">:</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="n">bl</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">vm</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;amp&#39;</span><span class="p">]</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%25s</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">bl</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">vm</span><span class="p">,</span><span class="n">err</span><span class="p">))</span>
    <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="write_closure_phases"><a class="viewcode-back" href="../../docs/src/data.html#data.data.write_closure_phases">[docs]</a><span class="k">def</span> <span class="nf">write_closure_phases</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keep_trivial_triangles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">choose_optimal_covariance_set</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes closure phases in Themis format given an :class:`ehtim.obsdata.Obsdata` object.</span>

<span class="sd">    Warning: </span>
<span class="sd">      * The :class:`ehtim.obsdata.Obsdata` must be read in with a polrep=&#39;stokes&#39;.  If this is not the case, raises a ValueError.  DO NOT SWITCH THE POLREP AS THIS INFLATES THE ERRORS.</span>
<span class="sd">      * This makes extensive use of ehtim and astropy and will not be available if either is not installed.  Raises a NotImplementedError if they are is unavailable.</span>

<span class="sd">    Args:</span>
<span class="sd">      obs (ehtim.obsdata.Obsdata): An ehtim Obsdata object containing the observation data (presumably repackaging a uvfits file).</span>
<span class="sd">      outname (str): Name of the output file to which to write data.</span>
<span class="sd">      snrcut (float): A possible signal-to-noise ratio below which to reject points. Default: 0.</span>
<span class="sd">      keep_trivial_triangles (bool): If True, closure phases on trivial triangles will be included. Trivial triangles are defined to be the those with a baselines shorter than 100 Mlambda.  Default: False.  </span>
<span class="sd">      choose_optimal_covariance_set (bool): If True, returns the maximally independent set closure phases.  Default: True.</span>

<span class="sd">    Returns:</span>
<span class="sd">      None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ehtim_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">astropy_found</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1"># Check polrep</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">polrep</span><span class="o">!=</span><span class="s1">&#39;stokes&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Must supply an obs object with polrep=&#39;stokes&#39;&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    
    <span class="c1"># Get some dataset particulars</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">source</span>
    <span class="n">mjd</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">mjd</span>
    <span class="n">t</span><span class="o">=</span><span class="n">Time</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>
    <span class="p">[</span><span class="n">year</span><span class="p">,</span><span class="n">day</span><span class="p">]</span><span class="o">=</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">t</span><span class="o">.</span><span class="n">yday</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>


    <span class="c1"># Remove trivial triangles if not keeping them.</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">keep_trivial_triangles</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">flag_uvdist</span><span class="p">(</span><span class="mf">0.1e9</span><span class="p">)</span> <span class="c1">#Kill trivial triangles</span>

    <span class="c1"># Get the set of closure phase observations</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">choose_optimal_covariance_set</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">obs_cphase_arr</span> <span class="o">=</span> <span class="n">closure_phase_covariance_ordering</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">obs</span><span class="o">.</span><span class="n">add_cphase</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
        <span class="n">obs_cphase_arr</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">cphase</span>

    <span class="c1"># Write header</span>
    <span class="n">out</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">outname</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%24s</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%4s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="s1"> </span><span class="si">%15s</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="s1">&#39; day&#39;</span><span class="p">,</span><span class="s1">&#39;time (hr)&#39;</span><span class="p">,</span><span class="s1">&#39;base&#39;</span><span class="p">,</span><span class="s1">&#39;u1 (Ml)&#39;</span><span class="p">,</span><span class="s1">&#39;v1 (Ml)&#39;</span><span class="p">,</span><span class="s1">&#39;u2 (Ml)&#39;</span><span class="p">,</span><span class="s1">&#39;v2 (Ml)&#39;</span><span class="p">,</span><span class="s1">&#39;CP (deg)&#39;</span><span class="p">,</span><span class="s1">&#39;err (deg)&#39;</span><span class="p">))</span>
    
    <span class="c1">#Now output the data</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_cphase_arr</span><span class="p">)):</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">triangle_list</span> <span class="o">=</span> <span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">+</span><span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;t3&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">u1</span> <span class="o">=</span> <span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">u3</span> <span class="o">=</span> <span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">v3</span> <span class="o">=</span> <span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span><span class="o">/</span><span class="mf">1e6</span>
        <span class="n">CP</span> <span class="o">=</span> <span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;cphase&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">sCP</span> <span class="o">=</span> <span class="n">obs_cphase_arr</span><span class="p">[</span><span class="s1">&#39;sigmacp&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">u1</span><span class="o">+</span><span class="n">u2</span><span class="o">+</span><span class="n">u3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">v1</span><span class="o">+</span><span class="n">v2</span><span class="o">+</span><span class="n">v3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Large triangle displacement detected: (du,dv)=(</span><span class="si">%g</span><span class="s2">,</span><span class="si">%g</span><span class="s2">).  This may happen for scan averaged data sets.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">u1</span><span class="o">+</span><span class="n">u2</span><span class="o">+</span><span class="n">u3</span><span class="p">,</span><span class="n">v1</span><span class="o">+</span><span class="n">v2</span><span class="o">+</span><span class="n">v3</span><span class="p">),</span> <span class="ne">Warning</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%25s</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%4i</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%6s</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="s1"> </span><span class="si">%15.8f</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">year</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">triangle_list</span><span class="p">,</span><span class="n">u1</span><span class="p">,</span><span class="n">v1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">v2</span><span class="p">,</span><span class="n">CP</span><span class="p">,</span><span class="n">sCP</span><span class="p">))</span>
        
    <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> </div>


<span class="k">def</span> <span class="nf">write_closure_amplitudes</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">outname</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<span class="k">def</span> <span class="nf">write_polarization_fractions</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span><span class="n">outname</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>



<div class="viewcode-block" id="read_crosshand_visibilities"><a class="viewcode-back" href="../../docs/src/data.html#data.data.read_crosshand_visibilities">[docs]</a><span class="k">def</span> <span class="nf">read_crosshand_visibilities</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a themis-style amplitude data file and returns a dictionary object.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename (str) :  Name of the file containing Themis-style data.</span>
<span class="sd">      verbosity (int) : Verbosity level. Default: 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">      (dict) : Dictionary containing data with additional information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">datadict</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;field rotation 1&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;field rotation 2&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;RR&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;RR error&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;LL&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;LL error&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;RL&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;RL error&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;LR&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;LR error&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># Skip headers/comment/flagged lines</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">toks</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;field rotation 1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;field rotation 2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;RR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">11</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;RR error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">12</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;LL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">15</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;LL error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">16</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;RL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">19</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;RL error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">18</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">20</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;LR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">21</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">23</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;LR error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">22</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">24</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
        <span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%15s</span><span class="s2"> : &quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">][:</span><span class="mi">5</span><span class="p">])</span>
        
    <span class="k">return</span> <span class="n">datadict</span></div>
        

<div class="viewcode-block" id="read_visibilities"><a class="viewcode-back" href="../../docs/src/data.html#data.data.read_visibilities">[docs]</a><span class="k">def</span> <span class="nf">read_visibilities</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a themis-style amplitude data file and returns a dictionary object.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename (str) :  Name of the file containing Themis-style data.</span>
<span class="sd">      verbosity (int) : Verbosity level. Default: 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">      (dict) : Dictionary containing data with additional information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">datadict</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># Skip headers/comment/flagged lines</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">toks</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">+</span><span class="mf">1.0</span><span class="n">j</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">10</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
        <span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%15s</span><span class="s2"> : &quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">][:</span><span class="mi">5</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">datadict</span></div>
        

<div class="viewcode-block" id="read_amplitudes"><a class="viewcode-back" href="../../docs/src/data.html#data.data.read_amplitudes">[docs]</a><span class="k">def</span> <span class="nf">read_amplitudes</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a themis-style amplitude data file and returns a dictionary object.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename (str) :  Name of the file containing Themis-style data.</span>
<span class="sd">      verbosity (int) : Verbosity level. Default: 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">      (dict) : Dictionary containing data with additional information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">datadict</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># Skip headers/comment/flagged lines</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">toks</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
        <span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%15s</span><span class="s2"> : &quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">][:</span><span class="mi">5</span><span class="p">])</span>
            
    <span class="k">return</span> <span class="n">datadict</span></div>


<div class="viewcode-block" id="read_closure_phases"><a class="viewcode-back" href="../../docs/src/data.html#data.data.read_closure_phases">[docs]</a><span class="k">def</span> <span class="nf">read_closure_phases</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a themis-style closure phase data file and returns a dictionary object.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename (str) :  Name of the file containing Themis-style data.</span>
<span class="sd">      verbosity (int) : Verbosity level. Default: 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">      (dict) : Dictionary containing data with additional information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">datadict</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;triangle&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;closure phase&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="p">:</span>
        <span class="c1"># Skip headers/comment/flagged lines</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">toks</span><span class="o">=</span><span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;triangle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span><span class="p">)</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;closure phase&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span>
        <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">10</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
        <span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span>
    <span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">datadict</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">datadict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;</span><span class="si">%15s</span><span class="s2"> : &quot;</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="n">datadict</span><span class="p">[</span><span class="n">key</span><span class="p">][:</span><span class="mi">5</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">datadict</span></div>



<div class="viewcode-block" id="read_closure_amplitudes"><a class="viewcode-back" href="../../docs/src/data.html#data.data.read_closure_amplitudes">[docs]</a><span class="k">def</span> <span class="nf">read_closure_amplitudes</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a themis-style closure amplitude data file and returns a dictionary object.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename (str) :  Name of the file containing Themis-style data.</span>
<span class="sd">      verbosity (int) : Verbosity level. Default: 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">      (dict) : Dictionary containing data with additional information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<div class="viewcode-block" id="read_polarization_fractions"><a class="viewcode-back" href="../../docs/src/data.html#data.data.read_polarization_fractions">[docs]</a><span class="k">def</span> <span class="nf">read_polarization_fractions</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a themis-style closure amplitude data file and returns a dictionary object.</span>

<span class="sd">    Args:</span>
<span class="sd">      filename (str) :  Name of the file containing Themis-style data.</span>
<span class="sd">      verbosity (int) : Verbosity level. Default: 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">      (dict) : Dictionary containing data with additional information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>


<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<div class="viewcode-block" id="write_uvfits"><a class="viewcode-back" href="../../docs/src/data.html#data.data.write_uvfits">[docs]</a><span class="k">def</span> <span class="nf">write_uvfits</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">outname</span><span class="p">,</span> <span class="n">gain_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dterm_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">relative_timestamps</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes uvfits file given an :class:`ehtim.obsdata.Obsdata` object.  Potentially applies gains and/or dterms from a Themis analysis </span>

<span class="sd">    Warning: </span>
<span class="sd">      * This makes extensive use of ehtim and will not be available if ehtim is not installed.  Raises a NotImplementedError if ehtim is unavailable.</span>
<span class="sd">      * D term calibration not yet implemented.</span>

<span class="sd">    Args:</span>
<span class="sd">      obs (ehtim.obsdata.Obsdata): An ehtim Obsdata object containing the observation data (presumably repackaging a uvfits file).</span>
<span class="sd">      outname (str): Name of the output file to which to write data.</span>
<span class="sd">      gains (dictionary): Station gains organized as a dictionary indexed by the station codes in :class:`ehtim.obsdata.tarr`.</span>
<span class="sd">      dterms (dictionary): Station D terms organized as a dictionary indexed by the station codes in :class:`ehtim.obsdata.tarr`.</span>
<span class="sd">      relative_timestamps (bool): If True, will assume that the times in the calibration files apply to the given data set and apply in order. Requires that the number of gains must match the number of time slices in the data set. Exists prirmarily to address poor absolute time specification of earlier gain files. In almost all new Themis analyses after Apr 22, 2020, should be False.</span>
<span class="sd">      verbosity (int): Degree of verbosity.  0 only prints warnings and errors. 1 provides more granular output. 2 generates calibrated data plots. 3 generates cal table gain plots.  </span>

<span class="sd">    Returns:</span>
<span class="sd">      None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">## TODO: Fix it to figure out the relative start/stop times and apply the gains in the stated time bins.</span>
    <span class="c1">##</span>

    <span class="c1"># Flip gains from corrections to the model to adjust data, i.e., G -&gt; 1/G</span>
    <span class="n">gain_station_names</span> <span class="o">=</span> <span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;stations&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">gain_station_names</span> <span class="p">:</span>
        <span class="n">gain_data</span><span class="p">[</span><span class="n">sn</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">gain_data</span><span class="p">[</span><span class="n">sn</span><span class="p">]</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Gain data:&quot;</span><span class="p">,</span><span class="n">gain_data</span><span class="p">)</span>
        
    <span class="c1"># Get the unique times</span>
    <span class="n">od_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">))</span>
    <span class="n">od_time_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">od_time</span> <span class="p">:</span>
        <span class="n">od_time_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Check for consistency, if they are not consistent warn</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">relative_timestamps</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">gain_time_list</span> <span class="o">=</span> <span class="n">od_time_list</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">od_time_list</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">]))</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;When relative_timestamps=True, number of gain epochs (</span><span class="si">%i</span><span class="s2">) must match number of observation epochs (</span><span class="si">%i</span><span class="s2">).&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="n">od_time_list</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">od_time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">od_time_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;tend&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;gain_data does not cover the observation times.  Cowardly refusing to continue.&quot;</span><span class="p">)</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="c1"># Get the absolute times</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">od_time_list</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">]))</span> <span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;gain_data and observation data are not the same size! Will try to apply gains nonetheless ...&quot;</span><span class="p">,</span><span class="ne">Warning</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;toffset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">obs</span><span class="o">.</span><span class="n">mjd</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Observation and gain reconstruction dates differ (mjd </span><span class="si">%i</span><span class="s2"> vs </span><span class="si">%i</span><span class="s2">). Cowardly refusing to continue.&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;toffset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mjd</span><span class="p">)))</span>
        <span class="n">gain_time_offset_hour</span> <span class="o">=</span> <span class="mf">24.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;toffset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mjd</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gain_time_list</span> <span class="o">=</span> <span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">gain_time_offset_hour</span>
        <span class="n">time_precision_slop</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="o">/</span><span class="mf">3600.0</span> <span class="c1"># Permit a slop of 1 ms in the time comparisons</span>
        <span class="k">if</span> <span class="p">(</span> <span class="n">od_time_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">gain_time_offset_hour</span><span class="o">-</span><span class="n">time_precision_slop</span> <span class="ow">or</span> <span class="n">od_time_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="n">gain_data</span><span class="p">[</span><span class="s1">&#39;tend&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">gain_time_offset_hour</span><span class="o">+</span><span class="n">time_precision_slop</span> <span class="p">)</span> <span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;gain_data does not cover the observation times. Cowardly refusing to continue.&quot;</span><span class="p">)</span>

        
    <span class="c1"># Generate Caltable object</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sites:&quot;</span><span class="p">,</span><span class="n">gain_station_names</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Times:&quot;</span><span class="p">,</span><span class="n">od_time_list</span><span class="p">)</span>
    <span class="n">datatables</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#for k in range(len(gain_station_names)):</span>
    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">gain_station_names</span> <span class="p">:</span>
        <span class="n">datatable</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gain_time_list</span><span class="p">)):</span>
            <span class="n">datatable</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">gain_time_list</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">gain_data</span><span class="p">[</span><span class="n">station</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">gain_data</span><span class="p">[</span><span class="n">station</span><span class="p">][</span><span class="n">j</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">eh</span><span class="o">.</span><span class="n">DTCAL</span><span class="p">))</span>
        <span class="n">datatables</span><span class="p">[</span><span class="n">station</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">datatable</span><span class="p">)</span>
    <span class="n">cal</span><span class="o">=</span><span class="n">eh</span><span class="o">.</span><span class="n">caltable</span><span class="o">.</span><span class="n">Caltable</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">datatables</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">timetype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">timetype</span><span class="p">)</span>

    <span class="c1"># Calibrate the observation data (Yikes!!)</span>
    <span class="n">obs_cal</span> <span class="o">=</span> <span class="n">cal</span><span class="o">.</span><span class="n">applycal</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

    <span class="c1"># Write out new uvfits file</span>
    <span class="n">obs_cal</span><span class="o">.</span><span class="n">save_uvfits</span><span class="p">(</span><span class="n">outname</span><span class="p">)</span>

    <span class="c1"># Make calibrated data plots if desired</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">eh</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">comp_plots</span><span class="o">.</span><span class="n">plotall_obs_compare</span><span class="p">([</span><span class="n">obs</span><span class="p">,</span><span class="n">obs_cal</span><span class="p">],</span><span class="s1">&#39;uvdist&#39;</span><span class="p">,</span><span class="s1">&#39;amp&#39;</span><span class="p">)</span>
        
    <span class="c1"># Make gain plots if desired</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">cal</span><span class="o">.</span><span class="n">plot_gains</span><span class="p">([])</span>
    
    <span class="c1"># Show the plots if relevant</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">verbosity</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">)</span> <span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Themis Development Team.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.3.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            LINK_SUFFIX:'.html', 
            HAS_SOURCE: 'true'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>